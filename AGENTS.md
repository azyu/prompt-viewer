# Prompt Viewer - Project Context

## Project Overview

**Prompt Viewer** is a desktop application designed to read and display metadata from images generated by Stable Diffusion. It is built using **Electron**.

The application allows users to inspect the prompts (positive and negative) and generation parameters (seed, steps, CFG scale, model) hidden within image files. It specifically supports formats and metadata conventions used by:
*   **Automatic1111 (A1111)**: Reads from standard Exif `UserComment` or `parameters` tags.
*   **ComfyUI**: Parses complex workflow JSON embedded in `prompt` or `workflow` tags, extracting inputs from `KSampler` and text encoder nodes.

## Architecture

The project follows a standard Electron architecture with strict security practices (Context Isolation enabled, Node Integration disabled).

### 1. Main Process (`src/main.js`)
*   **Entry Point**: Initializes the application window.
*   **Window Config**: Creates a 1200x800 window with a custom frameless dark-themed title bar (`titleBarStyle: 'hidden'`).
*   **Security**: Enforces `contextIsolation: true` and `nodeIntegration: false`.

### 2. Preload Script (`src/preload.js`)
*   Acts as the bridge between Main and Renderer processes.
*   **Exposed API**: `window.electronAPI.parseMetadata(arrayBuffer)`
*   **Dependencies**: Uses the `exifreader` library in the Node context to safely parse image metadata and return the tags to the renderer.

### 3. Renderer Process (`src/renderer.js`)
*   **UI Logic**: Handles drag-and-drop events, file selection, and DOM updates.
*   **Metadata Parsing**: Contains specific logic to interpret metadata tags:
    *   **Standard/A1111**: Regex parsing of the "parameters" text block.
    *   **ComfyUI**: Recursive traversal of the JSON node graph to trace text inputs connected to `KSampler` nodes (Positive/Negative) and identifying "Source" vs "Rendered" text (e.g., wildcards).
*   **Features**:
    *   Image Preview.
    *   Copy-to-clipboard buttons for prompts.
    *   Attribute grid display (Seed, Sampler, etc.).
    *   Toggle between "Rendered" (final text) and "Source" (template text) prompt modes.

## Directory Structure

*   `src/`
    *   `main.js`: Electron main process.
    *   `preload.js`: Context bridge.
    *   `renderer.js`: Frontend logic.
    *   `index.html`: Main UI layout.
    *   `styles.css`: Application styling.
*   `forge.config.js`: Configuration for Electron Forge (packaging/building).
*   `package.json`: Dependencies and scripts.

## Development & Usage

### Prerequisites
*   Node.js and npm installed.

### Commands

*   **Install Dependencies:**
    ```bash
    npm install
    ```

*   **Start Development Mode:**
    ```bash
    npm start
    ```
    (Runs `electron-forge start`)

*   **Build/Package:**
    ```bash
    npm run make
    ```
    (Runs `electron-forge make` to create platform-specific distributables)

### Key Dependencies
*   `electron`: Framework.
*   `exifreader`: Metadata extraction.
*   `@electron-forge/cli`: Tooling for building and publishing.

## Conventions

*   **Styling**: Dark mode theme (`#0f172a` background).
*   **Code Style**: Vanilla JavaScript (ES6+).
*   **Security**: Always access Node.js APIs (like file reading or specific libraries) via `preload.js` and `contextBridge`.
